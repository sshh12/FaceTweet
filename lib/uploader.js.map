{"version":3,"sources":["../public/scripts/uploader.js"],"names":["window","friendlyPix","Uploader","maxDimension","quality","database","firebase","auth","storage","addPolyfills","$","document","ready","addButton","addButtonFloating","imageInput","overlay","newPictureContainer","uploadButton","imageCaptionInput","uploadPicForm","toast","click","initiatePictureCapture","change","readPicture","e","submit","uploadPic","keyup","prop","val","HTMLCanvasElement","prototype","toBlob","Object","defineProperty","value","callback","type","binStr","atob","toDataURL","split","len","length","arr","Uint8Array","i","charCodeAt","Blob","trigger","url","attr","page","focus","disabled","toggle","event","clear","file","target","files","currentFile","wrap","closest","get","reset","unwrap","match","reader","FileReader","onload","displayPicture","result","readAsDataURL","disableUploadUi","fullDeferred","Deferred","thumbDeferred","resolveFullBlob","resolve","blob","resolveThumbBlob","image","Image","src","maxThumbDimension","THUMB_IMAGE_SPECS","thumbCanvas","_getScaledCanvas","maxFullDimension","FULL_IMAGE_SPECS","fullCanvas","Promise","all","promise","then","full","results","thumb","preventDefault","imageCaption","generateImages","uploadNewPic","pics","name","currentUser","uid","data","message","actionHandler","postId","actionText","timeout","MaterialSnackbar","showSnackbar","console","error","cancelAllSubscriptions","MaterialUtils","clearTextField","createElement","width","height","getContext","drawImage","uploader"],"mappings":"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","file":"uploader.js","sourcesContent":["/**\n * Copyright 2015 Google Inc. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n'use strict';\n\nwindow.friendlyPix = window.friendlyPix || {};\n\n/**\n * Handles uploads of new pics.\n */\nfriendlyPix.Uploader = class {\n\n  /**\n   * @return {number}\n   */\n  static get FULL_IMAGE_SPECS() {\n    return {\n      maxDimension: 1280,\n      quality: 0.9\n    };\n  }\n\n  /**\n   * @return {number}\n   */\n  static get THUMB_IMAGE_SPECS() {\n    return {\n      maxDimension: 640,\n      quality: 0.7\n    };\n  }\n\n  /**\n   * Inititializes the pics uploader/post creator.\n   * @constructor\n   */\n  constructor() {\n    // Firebase SDK\n    this.database = firebase.database();\n    this.auth = firebase.auth();\n    this.storage = firebase.storage();\n\n    this.addPolyfills();\n\n    $(document).ready(() => {\n      // DOM Elements\n      this.addButton = $('#add');\n      this.addButtonFloating = $('#add-floating');\n      this.imageInput = $('#fp-mediacapture');\n      this.overlay = $('.fp-overlay', '#page-add');\n      this.newPictureContainer = $('#newPictureContainer');\n      this.uploadButton = $('.fp-upload');\n      this.imageCaptionInput = $('#imageCaptionInput');\n      this.uploadPicForm = $('#uploadPicForm');\n      this.toast = $('.mdl-js-snackbar');\n\n      // Event bindings\n      this.addButton.click(() => this.initiatePictureCapture());\n      this.addButtonFloating.click(() => this.initiatePictureCapture());\n      this.imageInput.change(e => this.readPicture(e));\n      this.uploadPicForm.submit(e => this.uploadPic(e));\n      this.imageCaptionInput.keyup(() => this.uploadButton.prop('disabled', !this.imageCaptionInput.val()));\n    });\n  }\n\n  // Adds polyfills required for the Uploader.\n  addPolyfills() {\n    // Polyfill for canvas.toBlob().\n    if (!HTMLCanvasElement.prototype.toBlob) {\n      Object.defineProperty(HTMLCanvasElement.prototype, 'toBlob', {\n        value: function(callback, type, quality) {\n          var binStr = atob(this.toDataURL(type, quality).split(',')[1]);\n          var len = binStr.length;\n          var arr = new Uint8Array(len);\n\n          for (var i = 0; i < len; i++) {\n            arr[i] = binStr.charCodeAt(i);\n          }\n\n          callback(new Blob([arr], {type: type || 'image/png'}));\n        }\n      });\n    }\n  }\n\n  /**\n   * Start taking a picture.\n   */\n  initiatePictureCapture() {\n    this.imageInput.trigger('click');\n  }\n\n  /**\n   * Displays the given pic in the New Pic Upload dialog.\n   */\n  displayPicture(url) {\n    this.newPictureContainer.attr('src', url);\n    page('/add');\n    this.imageCaptionInput.focus();\n    this.uploadButton.prop('disabled', true);\n  }\n\n  /**\n   * Enables or disables the UI. Typically while the image is uploading.\n   */\n  disableUploadUi(disabled) {\n    this.uploadButton.prop('disabled', disabled);\n    this.addButton.prop('disabled', disabled);\n    this.addButtonFloating.prop('disabled', disabled);\n    this.imageCaptionInput.prop('disabled', disabled);\n    this.overlay.toggle(disabled);\n  }\n\n  /**\n   * Reads the picture the has been selected by the file picker.\n   */\n  readPicture(event) {\n    this.clear();\n\n    var file = event.target.files[0]; // FileList object\n    this.currentFile = file;\n\n    // Clear the selection in the file picker input.\n    this.imageInput.wrap('<form>').closest('form').get(0).reset();\n    this.imageInput.unwrap();\n\n    // Only process image files.\n    if (file.type.match('image.*')) {\n      var reader = new FileReader();\n      reader.onload = e => this.displayPicture(e.target.result);\n      // Read in the image file as a data URL.\n      reader.readAsDataURL(file);\n      this.disableUploadUi(false);\n    }\n  }\n\n  /**\n   * Returns a Canvas containing the given image scaled down to the given max dimension.\n   * @private\n   * @static\n   */\n  static _getScaledCanvas(image, maxDimension) {\n    const thumbCanvas = document.createElement('canvas');\n    if (image.width > maxDimension ||\n      image.height > maxDimension) {\n      if (image.width > image.height) {\n        thumbCanvas.width = maxDimension;\n        thumbCanvas.height = maxDimension * image.height / image.width;\n      } else {\n        thumbCanvas.width = maxDimension * image.width / image.height;\n        thumbCanvas.height = maxDimension;\n      }\n    } else {\n      thumbCanvas.width = image.width;\n      thumbCanvas.height = image.height;\n    }\n    thumbCanvas.getContext('2d').drawImage(image, 0, 0, image.width, image.height,\n      0, 0, thumbCanvas.width, thumbCanvas.height);\n    return thumbCanvas;\n  }\n\n  /**\n   * Generates the full size image and image thumb using canvas and returns them in a promise.\n   */\n  generateImages() {\n    const fullDeferred = new $.Deferred();\n    const thumbDeferred = new $.Deferred();\n\n    const resolveFullBlob = blob => fullDeferred.resolve(blob);\n    const resolveThumbBlob = blob => thumbDeferred.resolve(blob);\n\n    const displayPicture = url => {\n      const image = new Image();\n      image.src = url;\n\n      // Generate thumb.\n      const maxThumbDimension = friendlyPix.Uploader.THUMB_IMAGE_SPECS.maxDimension;\n      const thumbCanvas = friendlyPix.Uploader._getScaledCanvas(image, maxThumbDimension);\n      thumbCanvas.toBlob(resolveThumbBlob, 'image/jpeg', friendlyPix.Uploader.THUMB_IMAGE_SPECS.quality);\n\n      // Generate full sized image.\n      const maxFullDimension = friendlyPix.Uploader.FULL_IMAGE_SPECS.maxDimension;\n      const fullCanvas = friendlyPix.Uploader._getScaledCanvas(image, maxFullDimension);\n      fullCanvas.toBlob(resolveFullBlob, 'image/jpeg', friendlyPix.Uploader.FULL_IMAGE_SPECS.quality);\n    };\n\n    const reader = new FileReader();\n    reader.onload = e => displayPicture(e.target.result);\n    reader.readAsDataURL(this.currentFile);\n\n    return Promise.all([fullDeferred.promise(), thumbDeferred.promise()]).then(results => {\n      return {\n        full: results[0],\n        thumb: results[1]\n      };\n    });\n  }\n\n  /**\n   * Uploads the pic to Cloud Storage and add a new post into the Firebase Database.\n   */\n  uploadPic(e) {\n    e.preventDefault();\n    this.disableUploadUi(true);\n    var imageCaption = this.imageCaptionInput.val();\n\n    this.generateImages().then(pics => {\n      // Upload the File upload to Cloud Storage and create new post.\n      friendlyPix.firebase.uploadNewPic(pics.full, pics.thumb, this.currentFile.name, imageCaption)\n          .then(postId => {\n            page(`/user/${this.auth.currentUser.uid}`);\n            var data = {\n              message: 'New pic has been posted!',\n              actionHandler: () => page(`/post/${postId}`),\n              actionText: 'View',\n              timeout: 10000\n            };\n            this.toast[0].MaterialSnackbar.showSnackbar(data);\n            this.disableUploadUi(false);\n          }, error => {\n            console.error(error);\n            var data = {\n              message: `There was an error while posting your pic. Sorry!`,\n              timeout: 5000\n            };\n            this.toast[0].MaterialSnackbar.showSnackbar(data);\n            this.disableUploadUi(false);\n          });\n        });\n  }\n\n  /**\n   * Clear the uploader.\n   */\n  clear() {\n    this.currentFile = null;\n\n    // Cancel all Firebase listeners.\n    friendlyPix.firebase.cancelAllSubscriptions();\n\n    // Clear previously displayed pic.\n    this.newPictureContainer.attr('src', '');\n\n    // Clear the text field.\n    friendlyPix.MaterialUtils.clearTextField(this.imageCaptionInput[0]);\n\n    // Make sure UI is not disabled.\n    this.disableUploadUi(false);\n  }\n};\n\nfriendlyPix.uploader = new friendlyPix.Uploader();\n"]}